---
- name: Ensure vector is removed before installing
  apt:
    name: vector
    state: absent

- name: Setup the vector user
  user:
    name: vector
    createhome: no
    home: /opt/vector
    shell: /usr/sbin/nologin

- name: Create the /etc/vector directory
  file:
    path: /etc/vector
    state: directory

- name: "Downloading Vector ({{ vector_version }})"
  get_url:
    url: "http://packages.timber.io/vector/{{ vector_version }}/vector-{{ vector_version }}-x86_64-unknown-linux-gnu.tar.gz"
    dest: /tmp/vector.tar.gz
    mode: 0775

- name: Create the /opt/vector/bin directory
  file:
    path: /opt/vector/bin
    state: directory

- name: Create the /var/lib/vector directory
  file:
    path: /var/lib/vector
    state: directory
    owner: vector
    group: vector
    mode: 0770

- name: Unarchive Vector to /opt/vector/bin
  unarchive:
    src: /tmp/vector.tar.gz
    dest: /tmp
    remote_src: yes

- name: Remove Vector archive
  file:
    path: /tmp/vector.tar.gz
    state: absent

- name: Install vector binary
  copy:
    src: /tmp/vector-{{ vector_version }}/bin/vector
    dest: /opt/vector/bin/vector
    remote_src: yes

- name: Install vector daemon systemd script
  copy:
    src: /tmp/vector-{{ vector_version }}/etc/systemd/vector.service
    dest: /etc/systemd/system/vector.service
    mode: 0644
    remote_src: yes

# This ensures that the process is not running. Each test is responsible
# for starting and stopp the relevant services.
- name: Ensure the vector service is stopped
  systemd:
    name: vector
    daemon_reload: yes
    enabled: no
    state: stopped
