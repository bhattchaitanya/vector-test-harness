#!/bin/bash
set -euo pipefail

# Init lib.
# shellcheck source=SCRIPTDIR/../lib/vector-test-harness/init.sh
source "$(cd "$(dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd)/../lib/vector-test-harness/init.sh"

#
# Usage
#

register_usage <<END
USAGE
   ssh -h host

DESCRIPTION
   SSHs onto the provided host.

OPTIONS
   -h  The IP address of the target host

EXAMPLES
   ./ssh -h 2.76.231.121
END

#
# Flags
#

HOST=''

while getopts "h:" o; do
  case "${o}" in
    h)
      HOST=${OPTARG}
      ;;
    *)
      fail_arg_invalid "Invalid option detected: $1"
      ;;
  esac
done
shift $((OPTIND-1))

#
# Requirements
#

if [ -z "$HOST" ]; then
  fail_arg_invalid "Error: you must supply a host via the -h flag"
fi

# Setup

OPTS=()
if [[ -n "${VECTOR_TEST_PRIV_KEY:-""}" ]]; then
  OPTS+=(-o "IdentityFile=$VECTOR_TEST_PRIV_KEY")
  OPTS+=(-o "IdentitiesOnly=yes")
fi

# Execute

exec ssh "${OPTS[@]}" "ubuntu@$HOST"
