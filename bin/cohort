#!/bin/bash
set -euo pipefail

# Init lib.
# shellcheck source=SCRIPTDIR/../lib/vector-test-harness/init.sh
source "$(cd "$(dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd)/../lib/vector-test-harness/init.sh"

#
# Usage
#

register_usage <<END
USAGE
   cohort [-s subject]

DESCRIPTION
   Prints a simple table that provides a cohort analysis of test
   results across all tests and all versions for a single subject.

OPTIONS
   -s  The test subject (Ex: vector,fluentbit,splunk_universal_forwarder,etc)

EXAMPLES
   ./cohort -s vector

   Vector Bechmark Cohort Analysis - avg (quantity)
   ------------------------------------------------
   name                       | v0.1.0-alpha.5-17-geb59a3f
   ---------------------------|---------------------------
   tcp_to_blackhole (default) | 6.2s (5)
END

#
# Flags
#

SUBJECT=''

while getopts "s:" o; do
  case "${o}" in
    s)
        SUBJECT=${OPTARG}
        ;;
    *)
      fail_arg_invalid "Invalid option detected: $1"
      ;;
  esac
done
shift $((OPTIND-1))

#
# Requirements
#

if [ -z "$SUBJECT" ]; then
  fail_arg_invalid "Error: you must supply a subject via the -s flag"
fi

#
# Header
#

print_vector_logo
print_divider

#
# Execute
#

EXECUTION_ID="$(execute_query "$(cat << EOF
SELECT
  name,
  configuration,
  version,
  COUNT(*) AS count,
  AVG(duration) AS avg_duration
FROM (
  SELECT
    name,
    configuration,
    version,
    MAX(epoch) - MIN(epoch) AS duration
  FROM vector_tests
  WHERE subject='$SUBJECT'
  GROUP BY name, configuration, version, timestamp, hostname
)
GROUP BY name, configuration, version
ORDER BY version ASC
EOF
)")"

RESULTS=$(athena_get_results "$EXECUTION_ID")

"$VECTOR_TEST_HARNESS_UTILS_DIR/print_cohort" "$RESULTS"
