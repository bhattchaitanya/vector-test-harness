#!/usr/bin/env bash
set -euo pipefail

#
# Init
#

# shellcheck source=SCRIPTDIR/../lib/vector-test-harness/init.sh
source "$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)/../lib/vector-test-harness/init.sh"

# shellcheck source=SCRIPTDIR/test_subjects.sh
source "${VECTOR_TEST_HARNESS_LIB_ROOT}/test_subjects.sh"

#
# Usage
#

register_usage <<END
USAGE
   build-amis

DESCRIPTION
   Builds the various AMIs necessary to run the test cases. This saves quite
   a bit of time when tests are consecutively run, avoiding the need to
   install dependencies and test subjects.

OPTIONS
   none

EXAMPLES
   ./build-amis
END

#
# Dependencies
#

ensure_commad_available "ansible-playbook" "sudo pip install ansible"
ensure_commad_available "packer" "brew install packer"

#
# Variables
#

prepare_ansible_version_vars

#
# Header
#

print_vector_logo
print_divider
cat <<END
Test subject versions:
END
print_test_subject_versions "- "
print_divider
print_spacer

#
# Build AMIs
#

cd packer
export ANSIBLE_VERSION_VARS
packer build ami.json
