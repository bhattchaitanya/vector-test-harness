#!/bin/bash
set -euo pipefail

# Init lib.
# shellcheck source=SCRIPTDIR/../lib/vector-test-harness/init.sh
source "$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)/../lib/vector-test-harness/init.sh"

#
# Usage
#

register_usage <<END
USAGE
   build-amis

DESCRIPTION
   Builds the various AMIs necessary to run the test cases. This saves quite
   a bit of time when tests are consecutively run, avoiding the need to
   install dependencies and test subjects.

OPTIONS
   none

EXAMPLES
   ./build-amis
END

#
# Dependencies
#

ensure_commad_available "ansible-playbook" "sudo pip install ansible"
ensure_commad_available "packer" "brew install packer"

#
# Variables
#

TEST_SUBJECTS="$VECTOR_TEST_SUBJECTS"
prepare_ansible_version_vars "$TEST_SUBJECTS"

#
# Header
#

print_vector_logo
print_divider
cat <<END
Test subjects: $TEST_SUBJECTS
END
print_divider
print_spacer

#
# Build AMIs
#

cd packer
export ANSIBLE_VERSION_VARS
packer build ami.json
