---
- hosts: '{{ test_namespace }}'
  tasks:
    - meta: refresh_inventory
    - name: Wait 600 seconds for target connection to become reachable/usable
      wait_for_connection:

- hosts: '{{ test_namespace }}:&tag_TestRole_subject'
  become: true
  roles:
    # We include a TCP server in case the test subject needs it. This
    # is usefule for subjects that do not include simpler output means.
    - role: test_servers
      action: configure
      http_server_address: "127.0.0.1:{{ http_consumer_port }}"
      tcp_server_address: "127.0.0.1:{{ tcp_consumer_port }}"

    - role: filebeat
      action: configure
      configuration_file: "config_files/filebeat.yml"

    - role: fluentbit
      action: configure
      configuration_files:
        - src: config_files/td-agent-bit.conf
          dest: td-agent-bit.conf
        - src: config_files/td-agent-bit.parsers.conf
          dest: parsers.conf

    - role: fluentd
      action: configure
      configuration_file: "config_files/td-agent.conf"

    - role: logstash
      action: configure
      configuration_file: "config_files/logstash.settings.yml"
      pipeline_file: "config_files/logstash.pipeline.conf"
      
    - role: vector
      action: configure
      configuration_file: "config_files/vector.toml"

