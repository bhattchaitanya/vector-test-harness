---
- hosts: '{{ test_namespace }}'
  tasks:
    - meta: refresh_inventory
    - name: Wait 600 seconds for target connection to become reachable/usable
      wait_for_connection:

- hosts: '{{ test_namespace }}:&tag_TestRole_producer'
  become: true
  tasks:
    - name: Remove previous test log file
      file:
        path: /tmp/flog-100MiB.log
        state: absent

    - name: Create 100MiB test log file
      shell: |
        flog --format apache_common --bytes 104857600 | \
          jq -c --raw-input '{msg: .}' \
          > /tmp/flog-100MiB.log

- hosts: '{{ test_namespace }}:&tag_TestRole_subject'
  become: true
  roles:
    - role: fluentbit
      action: configure
      configuration_files:
        - src: config_files/td-agent-bit.conf
          dest: td-agent-bit.conf
      configuration_file: "config_files/td-agent-bit.conf"

    - role: fluentd
      action: configure
      configuration_file: "config_files/td-agent.conf"

    - role: logstash
      action: configure
      pipeline_file: "config_files/logstash.conf"
    
    - role: vector
      action: configure
      configuration_file: "config_files/vector.toml"
