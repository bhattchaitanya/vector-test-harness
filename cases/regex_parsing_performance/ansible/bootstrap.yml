---
- hosts: '{{ test_namespace }}'
  tasks:
    - meta: refresh_inventory
    - name: Wait 600 seconds for target connection to become reachable/usable
      wait_for_connection:

- hosts: '{{ test_namespace }}'
  become: true
  tasks:
    - set_fact:
        consumer_instance: "{{ hostvars[groups['tag_Name_vector_test_' + user_id + '_' + test_name + '_' + test_configuration + '_consumer'].0] }}"

- hosts: '{{ test_namespace }}:&tag_TestRole_producer'
  become: true
  tasks:
    - name: Remove previous test log file
      file:
        path: /tmp/flog-100MiB.log
        state: absent

    - name: Create 100MiB test log file
      shell: |
        flog --format apache_common --bytes 104857600 > /tmp/flog-100MiB.log

- hosts: '{{ test_namespace }}:&tag_TestRole_subject'
  become: true
  roles:
    # - role: fluentbit
    #   action: configure
    #   configuration_files:
    #     - src: config_files/td-agent-bit.conf
    #       dest: td-agent-bit.conf
    #     - src: config_files/td-agent-bit.parsers.conf
    #       dest: parsers.conf

    # - role: fluentd
    #   action: configure
    #   configuration_file: "config_files/td-agent.conf"

    # - role: logstash
    #   action: configure
    #   version: "{{ logstash_version }}"
    #   pipeline_file: "config_files/logstash.conf"

    # - role: splunk_heavy_forwarder
    #   action: configure
    #   configuration_files:
    #     - src: config_files/splunk.inputs.conf
    #       dest: inputs.conf
    #     - src: config_files/splunk.outputs.conf
    #       dest: outputs.conf
    #     - src: config_files/splunk.props.conf
    #       dest: props.conf
    #     - src: config_files/splunk.transforms.conf
    #       dest: transforms.conf

    # - role: telegraf
    #   action: configure
    #   configuration_file: "config_files/telegraf.conf"

    - role: vector
      action: install

    - role: vector
      action: configure
      configuration_file: "config_files/vector.toml"

- hosts: '{{ test_namespace }}:&tag_TestRole_consumer'
  become: true
  roles:
    - role: tcp_test_server
      action: configure
      server_address: "0.0.0.0:{{ consumer_port }}"
